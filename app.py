import streamlit as st
import swisseph as swe
from datetime import datetime, timedelta
import pytz

# роЖрокрпН роЕроорпИрокрпНрокрпБроХро│рпН
st.set_page_config(page_title="Ultimate Tamil Drik Panchangam", layout="wide")
IST = pytz.timezone('Asia/Kolkata')

# --- CSS ро╡роЯро┐ро╡роорпИрокрпНрокрпБ (рооро╛ро▒рпНро▒рокрпНрокроЯро╡ро┐ро▓рпНро▓рпИ) ---
st.markdown("""
    <style>
    .stApp { background-color: #FDFCF0; }
    .header-style { color: #8B0000; text-align: center; font-family: 'Tamil'; font-weight: bold; margin-bottom: 20px; }
    .panchang-table {
        width: 100%; border-collapse: collapse; background: white;
        border-radius: 15px; overflow: hidden; box-shadow: 0 4px 15px rgba(0,0,0,0.1);
    }
    .panchang-table th { background-color: #8B0000; color: white; padding: 15px; text-align: left; }
    .panchang-table td { padding: 12px 15px; border: 1px solid #eee; color: #333; font-weight: 600; }
    .sub-text { color: #666; font-size: 0.85em; font-weight: normal; }
    .special-note { background-color: #FFF9C4; padding: 10px; border-left: 5px solid #FBC02D; margin-top: 10px; font-weight: bold; }
    </style>
    """, unsafe_allow_html=True)

# рооро╛ро╡роЯрпНроЯроЩрпНроХро│рпН родро░ро╡рпБ
districts = {
    "роЕро░ро┐ропро▓рпВро░рпН": [11.1401, 79.0786], "роЪрпЖройрпНройрпИ": [13.0827, 80.2707], "роХрпЛропроорпНрокрпБродрпНродрпВро░рпН": [11.0168, 76.9558],
    "роородрпБро░рпИ": [9.9252, 78.1198], "родро┐ро░рпБроЪрпНроЪро┐ро░ро╛рокрпНрокро│рпНро│ро┐": [10.7905, 78.7047], "родро┐ро░рпБроирпЖро▓рпНро╡рпЗро▓ро┐": [8.7139, 77.7567],
    "роЪрпЗро▓роорпН": [11.6643, 78.1460], "родроЮрпНроЪро╛ро╡рпВро░рпН": [10.7870, 79.1378], "ро╡рпЗро▓рпВро░рпН": [12.9165, 79.1325]
    # роХрпВроЯрпБродро▓рпН рооро╛ро╡роЯрпНроЯроЩрпНроХро│рпИ родрпЗро╡рпИроХрпНроХрпЗро▒рпНрок роЗродрпЗ ро╡ро░ро┐роЪрпИропро┐ро▓рпН роЪрпЗро░рпНроХрпНроХро▓ро╛роорпН
}

def get_full_panchang(date_obj, lat, lon):
    jd_ut = swe.julday(date_obj.year, date_obj.month, date_obj.day, 0.0) 
    swe.set_sid_mode(swe.SIDM_LAHIRI)
    swe.set_topo(lon, lat, 0)

    def get_raw_astronomy(jd):
        m, _ = swe.calc_ut(jd, swe.MOON, swe.FLG_SIDEREAL)
        s, _ = swe.calc_ut(jd, swe.SUN, swe.FLG_SIDEREAL)
        m_deg, s_deg = m[0], s[0]
        diff = (m_deg - s_deg) % 360
        t_idx = int(diff / 12)
        n_idx = int(m_deg / (360/27))
        return m_deg, s_deg, t_idx, n_idx

    m_start, s_start, t_now, n_now = get_raw_astronomy(jd_ut)

    # рокро╛роХрпИ роЕроЯро┐рокрпНрокроЯрпИ роирпЗро░роХрпН роХрогроХрпНроХрпАроЯрпБ (35 Iterations)
    def find_end_time(jd_base, current_idx, calc_type):
        low, high = 0.0, 1.3
        for _ in range(35):
            mid = (low + high) / 2
            _, _, t, n = get_raw_astronomy(jd_base + mid)
            val = n if calc_type == "nak" else t
            if val == current_idx: low = mid
            else: high = mid
        return datetime.combine(date_obj, datetime.min.time()) + timedelta(hours=5.5) + timedelta(days=low)

    t_end = find_end_time(jd_ut, t_now, "tithi")
    
    day_idx = date_obj.weekday()
    wara = ["родро┐роЩрпНроХро│рпН", "роЪрпЖро╡рпНро╡ро╛ропрпН", "рокрпБродройрпН", "ро╡ро┐ропро╛ро┤ройрпН", "ро╡рпЖро│рпНро│ро┐", "роЪройро┐", "роЮро╛ропро┐ро▒рпБ"][day_idx]

    # ро░ро╛роХрпБ, роОроо, роХрпБро│ро┐роХрпИ (Standard)
    rahu = ["07:30-09:00", "15:00-16:30", "12:00-13:30", "13:30-15:00", "10:30-12:00", "09:00-10:30", "16:30-18:00"][day_idx]
    yema = ["10:30-12:00", "09:00-10:30", "07:30-09:00", "06:00-07:30", "15:00-16:30", "13:30-15:00", "12:00-13:30"][day_idx]
    kuli = ["13:30-15:00", "12:00-13:30", "10:30-12:00", "09:00-10:30", "07:30-09:00", "06:00-07:30", "15:00-16:30"][day_idx]

    # роЪрпВро▓роорпН рооро▒рпНро▒рпБроорпН рокро░ро┐роХро╛ро░роорпН
    shoolam_data = {
        "родро┐роЩрпНроХро│рпН": ["роХро┐ро┤роХрпНроХрпБ", "родропро┐ро░рпН"], "роЪрпЖро╡рпНро╡ро╛ропрпН": ["ро╡роЯроХрпНроХрпБ", "рокро╛ро▓рпН"], "рокрпБродройрпН": ["ро╡роЯроХрпНроХрпБ", "рокро╛ро▓рпН"],
        "ро╡ро┐ропро╛ро┤ройрпН": ["родрпЖро▒рпНроХрпБ", "родрпИро▓роорпН"], "ро╡рпЖро│рпНро│ро┐": ["роорпЗро▒рпНроХрпБ", "ро╡рпЖро▓рпНро▓роорпН"], "роЪройро┐": ["роХро┐ро┤роХрпНроХрпБ", "родропро┐ро░рпН"], "роЮро╛ропро┐ро▒рпБ": ["роорпЗро▒рпНроХрпБ", "ро╡рпЖро▓рпНро▓роорпН"]
    }
    shoolam, pariharam = shoolam_data[wara]

    # роХрпМро░ро┐ роиро▓рпНро▓ роирпЗро░роорпН (рокроХро▓рпН роороЯрпНроЯрпБроорпН - роОро│ро┐роп роХрогроХрпНроХрпАроЯрпБ)
    gowri_nalla = {
        "родро┐роЩрпНроХро│рпН": "01:30 - 02:30 PM", "роЪрпЖро╡рпНро╡ро╛ропрпН": "10:30 - 11:30 AM", "рокрпБродройрпН": "09:30 - 10:30 AM",
        "ро╡ро┐ропро╛ро┤ройрпН": "01:30 - 02:30 PM", "ро╡рпЖро│рпНро│ро┐": "12:30 - 01:30 PM", "роЪройро┐": "09:30 - 10:30 AM", "роЮро╛ропро┐ро▒рпБ": "10:30 - 11:30 AM"
    }

    # роЪро┐ро▒рокрпНрокрпБ ро╡ро┤ро┐рокро╛роЯрпБ (роЙродро╛ро░рог родро░ро╡рпБ - родро┐родро┐ роЕроЯро┐рокрпНрокроЯрпИропро┐ро▓рпН)
    special_worship = "роЗроирпНрод родро┐родро┐роХрпНроХрпБро░ро┐роп родрпЖропрпНро╡ ро╡ро┤ро┐рокро╛роЯрпБ роорой роЕроорпИродро┐ропрпИродрпН родро░рпБроорпН."
    if t_now == 13: special_worship = "роЪродрпБро░рпНродрпНродроЪро┐: роЪро┐ро╡рокрпЖро░рпБрооро╛ройрпН ро╡ро┤ро┐рокро╛роЯрпБ рооро▒рпНро▒рпБроорпН рокро┐ро░родрпЛро╖ ро╡ро┐ро░родроорпН роЪро┐ро▒рокрпНрокрпБ."
    elif t_now == 10: special_worship = "роПроХро╛родроЪро┐: роороХро╛ро╡ро┐ро╖рпНрогрпБ ро╡ро┤ро┐рокро╛роЯрпБ рооро▒рпНро▒рпБроорпН ро╡ро┐ро░родроорпН роороЩрпНроХро│роХро░рооро╛ройродрпБ."

    tithis = ["рокро┐ро░родроорпИ", "родрпБро╡ро┐родро┐ропрпИ", "родро┐ро░рпБродро┐ропрпИ", "роЪродрпБро░рпНродрпНродро┐", "рокроЮрпНроЪрооро┐", "роЪро╖рпНроЯро┐", "роЪрокрпНродрооро┐", "роЕро╖рпНроЯрооро┐", "роиро╡рооро┐", "родроЪрооро┐", "роПроХро╛родроЪро┐", "родрпБро╡ро╛родроЪро┐", "родро┐ро░ропрпЛродроЪро┐", "роЪродрпБро░рпНродрпНродроЪро┐", "рокрпМро░рпНрогрооро┐", "рокро┐ро░родроорпИ", "родрпБро╡ро┐родро┐ропрпИ", "родро┐ро░рпБродро┐ропрпИ", "роЪродрпБро░рпНродрпНродро┐", "рокроЮрпНроЪрооро┐", "роЪро╖рпНроЯро┐", "роЪрокрпНродрооро┐", "роЕро╖рпНроЯрооро┐", "роиро╡рооро┐", "родроЪрооро┐", "роПроХро╛родроЪро┐", "родрпБро╡ро╛родроЪро┐", "родро┐ро░ропрпЛродроЪро┐", "роЪродрпБро░рпНродрпНродроЪро┐", "роЕрооро╛ро╡ро╛роЪрпИ"]
    
    return {
        "wara": wara, "tithi": tithis[t_now % 30], "t_end": t_end.strftime("%I:%M %p"),
        "rahu": rahu, "yema": yema, "kuli": kuli, "shoolam": shoolam, "pariharam": pariharam,
        "gowri": gowri_nalla[wara], "special": special_worship
    }

# --- UI ---
st.markdown("<h1 class='header-style'>ЁЯФ▒ роорпБро┤рпБроорпИропро╛рой родро┐ро░рпБроХрпНроХрогро┐род рокроЮрпНроЪро╛роЩрпНроХроорпН</h1>", unsafe_allow_html=True)

with st.sidebar:
    selected_dist = st.selectbox("рооро╛ро╡роЯрпНроЯродрпНродрпИродрпН родрпЗро░рпНроирпНродрпЖроЯрпБроХрпНроХро╡рпБроорпН:", list(districts.keys()))
    selected_date = st.date_input("родрпЗродро┐ропрпИродрпН родрпЗро░рпНроирпНродрпЖроЯрпБроХрпНроХро╡рпБроорпН:", datetime.now(IST))

lat, lon = districts[selected_dist]
p = get_full_panchang(selected_date, lat, lon)

st.markdown(f"<div class='special-note'>ЁЯМЯ роЗройрпНро▒рпИроп роЪро┐ро▒рокрпНрокрпБ ро╡ро┤ро┐рокро╛роЯрпБ: {p['special']}</div>", unsafe_allow_html=True)

st.markdown(f"""
<table class="panchang-table">
    <tr><th>роЕроЩрпНроХроорпН</th><th>ро╡ро┐ро╡ро░роорпН ({selected_dist})</th></tr>
    <tr><td>ЁЯУЕ <b>роХро┐ро┤роорпИ & родро┐родро┐</b></td><td>{p['wara']} | <b>{p['tithi']}</b> (роорпБроЯро┐ро╡рпБ: {p['t_end']})</td></tr>
    <tr><td>тШАя╕П <b>роиро▓рпНро▓ роирпЗро░роорпН</b></td><td>роХро╛ро▓рпИ: 09:15 - 10:15 AM | рооро╛ро▓рпИ: 04:45 - 05:45 PM</td></tr>
    <tr><td>тЬи <b>роХрпМро░ро┐ роиро▓рпНро▓ роирпЗро░роорпН</b></td><td>{p['gowri']}</td></tr>
    <tr style="background-color: #FFF0F0;"><td>ЁЯЪл <b>роЕроЪрпБрок роирпЗро░роЩрпНроХро│рпН</b></td><td>ро░ро╛роХрпБ: {p['rahu']} | роОроо: {p['yema']} | роХрпБро│ро┐роХрпИ: {p['kuli']}</td></tr>
    <tr><td>ЁЯЪй <b>роЪрпВро▓роорпН & рокро░ро┐роХро╛ро░роорпН</b></td><td>роЪрпВро▓роорпН: {p['shoolam']} | рокро░ро┐роХро╛ро░роорпН: {p['pariharam']}</td></tr>
</table>
""", unsafe_allow_html=True)
