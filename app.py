import streamlit as st
import swisseph as swe
from datetime import datetime, timedelta, date
import pytz

from astral import LocationInfo
from astral.sun import sun
from timezonefinder import TimezoneFinder



# роЖрокрпН роЕроорпИрокрпНрокрпБроХро│рпН
st.set_page_config(page_title="Ultra Precise Tamil Panchangam", layout="wide")
IST = pytz.timezone('Asia/Kolkata')

# --- CSS ро╡роЯро┐ро╡роорпИрокрпНрокрпБ ---
st.markdown("""
    <style>
    .stApp { background-color: #FDFCF0; }
    .header-style { color: #8B0000; text-align: center; font-family: 'Tamil'; font-weight: bold; margin-bottom: 20px; }
    .panchang-table {
        width: 100%; border-collapse: collapse; background: white;
        border-radius: 15px; overflow: hidden; box-shadow: 0 4px 15px rgba(0,0,0,0.1);
    }
    .panchang-table th { background-color: #8B0000; color: white; padding: 15px; text-align: left; }
    .panchang-table td { padding: 12px 15px; border: 1px solid #eee; color: #333; font-weight: 600; }
    .sub-text { color: #666; font-size: 0.85em; font-weight: normal; }
    .special-note { background-color: #FFF9C4; padding: 15px; border-radius: 10px; border-left: 5px solid #FBC02D; margin-bottom: 20px; color: #5D4037; font-weight: bold; }
    </style>
    """, unsafe_allow_html=True)

# рооро╛ро╡роЯрпНроЯроЩрпНроХро│рпН родро░ро╡рпБ (Tamil Nadu Districts)
districts = {
    "роЕро░ро┐ропро▓рпВро░рпН": [11.1401, 79.0786], "роЪрпЖройрпНройрпИ": [13.0827, 80.2707], "роХрпЛропроорпНрокрпБродрпНродрпВро░рпН": [11.0168, 76.9558],
    "роХроЯро▓рпВро░рпН": [11.7480, 79.7714], "родро░рпНроорокрпБро░ро┐": [12.1271, 78.1582], "родро┐рогрпНроЯрпБроХрпНроХро▓рпН": [10.3673, 77.9803],
    "роИро░рпЛроЯрпБ": [11.3410, 77.7172], "роХро╛роЮрпНроЪро┐рокрпБро░роорпН": [12.8342, 79.7036], "роородрпБро░рпИ": [9.9252, 78.1198],
    "роиро╛роХрокрпНрокроЯрпНроЯро┐ройроорпН": [10.7672, 79.8444], "роиро╛роороХрпНроХро▓рпН": [11.2189, 78.1674], "рокрпБродрпБроХрпНроХрпЛроЯрпНроЯрпИ": [10.3797, 78.8202],
    "роЗро░ро╛роороиро╛родрокрпБро░роорпН": [9.3639, 78.8395], "роЪрпЗро▓роорпН": [11.6643, 78.1460], "родроЮрпНроЪро╛ро╡рпВро░рпН": [10.7870, 79.1378],
    "родро┐ро░рпБроЪрпНроЪро┐ро░ро╛рокрпНрокро│рпНро│ро┐": [10.7905, 78.7047], "родро┐ро░рпБроирпЖро▓рпНро╡рпЗро▓ро┐": [8.7139, 77.7567], "ро╡рпЗро▓рпВро░рпН": [12.9165, 79.1325]
}

def get_sunrise_sunset(date_obj, lat, lon):
    tf = TimezoneFinder()
    tz_name = tf.timezone_at(lat=lat, lng=lon)

    if tz_name is None:
        tz_name = "Asia/Kolkata"

    city = LocationInfo(
        name="Selected Location",
        region="",
        timezone=tz_name,
        latitude=lat,
        longitude=lon
    )

    s = sun(
        observer=city.observer,
        date=date_obj,
        tzinfo=pytz.timezone(tz_name)
    )

    return (
        s["sunrise"].strftime("%I:%M %p"),
        s["sunset"].strftime("%I:%M %p")
    )

def get_precise_panchang(date_obj, lat, lon):
    # 0.0 UT = 5:30 AM IST
    jd_ut = swe.julday(date_obj.year, date_obj.month, date_obj.day, 0.0) 
    swe.set_sid_mode(swe.SIDM_LAHIRI)
    swe.set_topo(lon, lat, 0)

    def get_raw_astronomy(jd):
        # роиро┐ро▓ро╡рпБ рооро▒рпНро▒рпБроорпН роЪрпВро░ро┐ропройро┐ройрпН родрпБро▓рпНро▓ро┐ропрооро╛рой рокро╛роХрпИроХро│рпН (Degrees)
        m, _ = swe.calc_ut(jd, swe.MOON, swe.FLG_SIDEREAL)
        s, _ = swe.calc_ut(jd, swe.SUN, swe.FLG_SIDEREAL)
        m_deg, s_deg = m[0], s[0]
        
        diff = (m_deg - s_deg) % 360
        t_idx = int(diff / 12)
        n_idx = int(m_deg / (360/27))
        y_idx = int(((m_deg + s_deg) % 360) / (360/27))
        k_idx = int(diff / 6) % 11
        return m_deg, s_deg, t_idx, n_idx, y_idx, k_idx

    # --- роирпАроЩрпНроХро│рпН роХрпЗроЯрпНроЯ роЕроирпНрод рооро┐роХ роорпБроХрпНроХро┐ропрооро╛рой рокро╛роХрпИ роХрогроХрпНроХрпАроЯрпБ (Binary Search - 35 Iterations) ---
    def find_boundary(jd_base, current_idx, calc_type):
        low, high = 0.0, 1.3 
        for _ in range(35):
            mid = (low + high) / 2
            _, _, t, n, _, _ = get_raw_astronomy(jd_base + mid)
            val = n if calc_type == "nak" else t
            if val == current_idx: low = mid
            else: high = mid
        return datetime.combine(date_obj, datetime.min.time()) + timedelta(hours=5.5) + timedelta(days=low)

    m_start, s_start, t_now, n_now, y_now, k_now = get_raw_astronomy(jd_ut)
    t_end_dt = find_boundary(jd_ut, t_now, "tithi")
    n_end_dt = find_boundary(jd_ut, n_now, "nak")

    # --- родрооро┐ро┤рпН рооро╛родроорпН рооро▒рпНро▒рпБроорпН родрпЗродро┐ роХрогроХрпНроХрпАроЯрпБ ---
    tamil_months = ["роЪро┐родрпНродро┐ро░рпИ", "ро╡рпИроХро╛роЪро┐", "роЖройро┐", "роЖроЯро┐", "роЖро╡рогро┐", "рокрпБро░роЯрпНроЯро╛роЪро┐", "роРрокрпНрокроЪро┐", "роХро╛ро░рпНродрпНродро┐роХрпИ", "рооро╛ро░рпНроХро┤ро┐", "родрпИ", "рооро╛роЪро┐", "рокроЩрпНроХрпБройро┐"]
    t_month = tamil_months[int(s_start / 30) % 12]
    t_date = int(s_start % 30) + 1

    # рокрпЖропро░рпНроХро│рпН рооро▒рпНро▒рпБроорпН роЯрпЗроЯрпНроЯро╛
    tithis = ["рокро┐ро░родроорпИ", "родрпБро╡ро┐родро┐ропрпИ", "родро┐ро░рпБродро┐ропрпИ", "роЪродрпБро░рпНродрпНродро┐", "рокроЮрпНроЪрооро┐", "роЪро╖рпНроЯро┐", "роЪрокрпНродрооро┐", "роЕро╖рпНроЯрооро┐", "роиро╡рооро┐", "родроЪрооро┐", "роПроХро╛родроЪро┐", "родрпБро╡ро╛родроЪро┐", "родро┐ро░ропрпЛродроЪро┐", "роЪродрпБро░рпНродрпНродроЪро┐", "рокрпМро░рпНрогрооро┐", "рокро┐ро░родроорпИ", "родрпБро╡ро┐родро┐ропрпИ", "родро┐ро░рпБродро┐ропрпИ", "роЪродрпБро░рпНродрпНродро┐", "рокроЮрпНроЪрооро┐", "роЪро╖рпНроЯро┐", "роЪрокрпНродрооро┐", "роЕро╖рпНроЯрооро┐", "роиро╡рооро┐", "родроЪрооро┐", "роПроХро╛родроЪро┐", "родрпБро╡ро╛родроЪро┐", "родро┐ро░ропрпЛродроЪро┐", "роЪродрпБро░рпНродрпНродроЪро┐", "роЕрооро╛ро╡ро╛роЪрпИ"]
    naks = ["роЕро╕рпНро╡ро┐ройро┐", "рокро░рогро┐", "роХро╛ро░рпНродрпНродро┐роХрпИ", "ро░рпЛроХро┐рогро┐", "рооро┐ро░рпБроХроЪрпАро░ро┐роЯроорпН", "родро┐ро░рпБро╡ро╛родро┐ро░рпИ", "рокрпБройро░рпНрокрпВроЪроорпН", "рокрпВроЪроорпН", "роЖропро┐ро▓рпНропроорпН", "роороХроорпН", "рокрпВро░роорпН", "роЙродрпНродро┐ро░роорпН", "роЕро╕рпНродроорпН", "роЪро┐родрпНродро┐ро░рпИ", "роЪрпБро╡ро╛родро┐", "ро╡ро┐роЪро╛роХроорпН", "роЕройрпБро╖роорпН", "роХрпЗроЯрпНроЯрпИ", "роорпВро▓роорпН", "рокрпВро░ро╛роЯроорпН", "роЙродрпНродро┐ро░ро╛роЯроорпН", "родро┐ро░рпБро╡рпЛрогроорпН", "роЕро╡ро┐роЯрпНроЯроорпН", "роЪродропроорпН", "рокрпВро░роЯрпНроЯро╛родро┐", "роЙродрпНродро┐ро░роЯрпНроЯро╛родро┐", "ро░рпЗро╡родро┐"]
    yogams = ["ро╡ро┐ро╖рпНроХроорпНрокроорпН", "рокрпНро░рпАродро┐", "роЖропрпБро╖рпНрооро╛ройрпН", "роЪрпМрокро╛роХрпНроХро┐ропроорпН", "роЪрпЛрокройроорпН", "роЕродро┐роХрогрпНроЯроорпН", "роЪрпБроХро░рпНроороорпН", "родро┐ро░рпБродро┐", "роЪрпВро▓роорпН", "роХрогрпНроЯроорпН", "ро╡ро┐ро░рпБродрпНродро┐", "родрпБро░рпБро╡роорпН", "ро╡ро┐ропро╛роХро╛родроорпН", "ро╣ро░рпНро╖рогроорпН", "ро╡роЬрпНро░роорпН", "роЪро┐родрпНродро┐", "ро╡ро┐ропродрпАрокро╛родроорпН", "ро╡ро░ро┐ропро╛ройрпН", "рокро░ро┐роХроорпН", "роЪро┐ро╡роорпН", "роЪро┐родрпНродроорпН", "роЪро╛родрпНродро┐ропроорпН", "роЪрпБрокроорпН", "роЪрпБрокрпНрокро┐ро░роорпН", "рокро┐ро░ро╛рооро┐ропроорпН", "роРроирпНродро░роорпН", "ро╡рпИродро┐ро░рпБродро┐"]
    karanams = ["рокро╡роорпН", "рокро╛ро▓ро╡роорпН", "роХрпМро▓ро╡роорпН", "роЪрпИродро┐ро▓рпИ", "роХро░роЪрпИ", "ро╡рогро┐роЪрпИ", "рокродрпНродро┐ро░рпИ", "роЪроХрпБройро┐", "роЪродрпБро╖рпНрокро╛родроорпН", "роиро╛роХро╡роорпН", "роХро┐роорпНро╕рпНродрпБроХрпНройроорпН"]

    day_idx = date_obj.weekday()
    wara = ["родро┐роЩрпНроХроЯрпНроХро┐ро┤роорпИ", "роЪрпЖро╡рпНро╡ро╛ропрпНроХрпНроХро┐ро┤роорпИ", "рокрпБродройрпНроХро┐ро┤роорпИ", "ро╡ро┐ропро╛ро┤роХрпНроХро┐ро┤роорпИ", "ро╡рпЖро│рпНро│ро┐роХрпНроХро┐ро┤роорпИ", "роЪройро┐роХрпНроХро┐ро┤роорпИ", "роЮро╛ропро┐ро▒рпНро▒рпБроХрпНроХро┐ро┤роорпИ"][day_idx]
    
    # ро░ро╛роХрпБ / роОроо / роХрпБро│ро┐роХрпИ
    rahu = ["07:30-09:00", "15:00-16:30", "12:00-13:30", "13:30-15:00", "10:30-12:00", "09:00-10:30", "16:30-18:00"][day_idx]
    yema = ["10:30-12:00", "09:00-10:30", "07:30-09:00", "06:00-07:30", "15:00-16:30", "13:30-15:00", "12:00-13:30"][day_idx]
    kuli = ["13:30-15:00", "12:00-13:30", "10:30-12:00", "09:00-10:30", "07:30-09:00", "06:00-07:30", "15:00-16:30"][day_idx]

    # роЪрпВро▓роорпН
    shoolam_map = {"родро┐роЩрпНроХроЯрпНроХро┐ро┤роорпИ": "роХро┐ро┤роХрпНроХрпБ", "роЪрпЖро╡рпНро╡ро╛ропрпНроХрпНроХро┐ро┤роорпИ": "ро╡роЯроХрпНроХрпБ", "рокрпБродройрпНроХро┐ро┤роорпИ": "ро╡роЯроХрпНроХрпБ", "ро╡ро┐ропро╛ро┤роХрпНроХро┐ро┤роорпИ": "родрпЖро▒рпНроХрпБ", "ро╡рпЖро│рпНро│ро┐роХрпНроХро┐ро┤роорпИ": "роорпЗро▒рпНроХрпБ", "роЪройро┐роХрпНроХро┐ро┤роорпИ": "роХро┐ро┤роХрпНроХрпБ", "роЮро╛ропро┐ро▒рпНро▒рпБроХрпНроХро┐ро┤роорпИ": "роорпЗро▒рпНроХрпБ"}
    
    # роХрпМро░ро┐ роиро▓рпНро▓ роирпЗро░роорпН (Static - рокрпКродрпБро╡ро╛ройродрпБ)
    gowri_map = {"родро┐роЩрпНроХроЯрпНроХро┐ро┤роорпИ": "01:30 - 02:30 PM", "роЪрпЖро╡рпНро╡ро╛ропрпНроХрпНроХро┐ро┤роорпИ": "10:30 - 11:30 AM", "рокрпБродройрпНроХро┐ро┤роорпИ": "09:30 - 10:30 AM", "ро╡ро┐ропро╛ро┤роХрпНроХро┐ро┤роорпИ": "01:30 - 02:30 PM", "ро╡рпЖро│рпНро│ро┐роХрпНроХро┐ро┤роорпИ": "12:30 - 01:30 PM", "роЪройро┐роХрпНроХро┐ро┤роорпИ": "09:30 - 10:30 AM", "роЮро╛ропро┐ро▒рпНро▒рпБроХрпНроХро┐ро┤роорпИ": "10:30 - 11:30 AM"}

    return {
        "m_deg": round(m_start, 2), "wara": wara,
        "tamil_month": t_month, "tamil_date": t_date,
        "tithi": tithis[t_now % 30], "tithi_end": t_end_dt.strftime("%d-%m %I:%M %p"), "next_tithi": tithis[(t_now+1)%30],
        "nak": naks[n_now % 27], "nak_end": n_end_dt.strftime("%d-%m %I:%M %p"), "next_nak": naks[(n_now+1)%27],
        "yog": yogams[y_now % 27], "kar": karanams[k_now % 11], "paksha": "ро╡ро│ро░рпНрокро┐ро▒рпИ" if t_now < 15 else "родрпЗропрпНрокро┐ро▒рпИ",
        "rahu": rahu, "yema": yema, "kuli": kuli, "shoolam": shoolam_map[wara], "gowri": gowri_map[wara]
    }

# --- UI ---
st.markdown("<h1 class='header-style'>ЁЯФ▒ родрооро┐ро┤рпНроиро╛роЯрпБ роорпБро┤рпБроорпИропро╛рой родро┐ро░рпБроХрпНроХрогро┐родрокрпН рокроЮрпНроЪро╛роЩрпНроХроорпН</h1>", unsafe_allow_html=True)

with st.sidebar:
    st.header("тЪЩя╕П роЕроорпИрокрпНрокрпБроХро│рпН")
    selected_dist = st.selectbox("рооро╛ро╡роЯрпНроЯродрпНродрпИродрпН родрпЗро░рпНроирпНродрпЖроЯрпБроХрпНроХро╡рпБроорпН:", list(districts.keys()))
    selected_date = st.date_input("родрпЗродро┐ропрпИродрпН родрпЗро░рпНроирпНродрпЖроЯрпБроХрпНроХро╡рпБроорпН:", datetime.now(IST))

lat, lon = districts[selected_dist]
p = get_precise_panchang(selected_date, lat, lon)
sunrise, sunset = get_sunrise_sunset(selected_date, lat, lon)


# роЪро┐ро▒рокрпНрокрпБ ро╡ро┤ро┐рокро╛роЯрпБ (роЙродро╛ро░рогроорпН)
if "роЪродрпБро░рпНродрпНродроЪро┐" in p['tithi']:
    st.markdown(f"<div class='special-note'>тЬи роЗройрпНро▒рпИроп роЪро┐ро▒рокрпНрокрпБ: роЪродрпБро░рпНродрпНродроЪро┐ - роЪро┐ро╡рокрпЖро░рпБрооро╛ройрпН рооро▒рпНро▒рпБроорпН рокро┐ро░родрпЛро╖ ро╡ро┤ро┐рокро╛роЯрпБ роЪро┐ро▒рокрпНрокрпБ. | {p['tamil_month']} {p['tamil_date']}</div>", unsafe_allow_html=True)
else:
    st.markdown(f"<div class='special-note'>ЁЯУЕ родрооро┐ро┤рпН родрпЗродро┐: {p['tamil_month']} {p['tamil_date']} | роЗройрпНро▒рпИроп ро╡ро┤ро┐рокро╛роЯрпБ: {p['tithi']} родро┐родро┐роХрпНроХрпБро░ро┐роп родрпЖропрпНро╡родрпНродрпИ ро╡рогроЩрпНроХрпБро╡родрпБ роиро▓роорпН родро░рпБроорпН.</div>", unsafe_allow_html=True)

st.markdown(f"""
<table class="panchang-table">
    <tr><th>роЕроЩрпНроХроорпН</th><th>ро╡ро┐ро╡ро░роорпН ({selected_dist})</th></tr>
    <tr>
  <td>ЁЯМЕ <b>роЪрпВро░ро┐роп роЙродропроорпН / роЕро╕рпНродрооройроорпН</b></td>
  <td>
    роЙродропроорпН: <b>{sunrise}</b><br>
    роЕро╕рпНродрооройроорпН: <b>{sunset}</b>
 
    <tr><td>ЁЯУЕ <b>родрооро┐ро┤рпН рооро╛родроорпН & родрпЗродро┐</b></td><td><b>{p['tamil_month']} {p['tamil_date']}</b> | {p['wara']}</td></tr>
    <tr><td>ЁЯМЩ <b>родро┐родро┐ роЪроЮрпНроЪро╛ро░роорпН</b></td><td><b>{p['tithi']}</b> ({p['paksha']})<br><span class='sub-text'>роорпБроЯро┐ро╡рпБ: {p['tithi_end']}</span><br><span class='sub-text'>роЕроЯрпБродрпНродрпБ: {p['next_tithi']}</span></td></tr>
    <tr><td>тнР <b>роироЯрпНроЪродрпНродро┐ро░роорпН</b></td><td><b>{p['nak']}</b><br><span class='sub-text'>роорпБроЯро┐ро╡рпБ: {p['nak_end']}</span><br><span class='sub-text'>роЕроЯрпБродрпНродрпБ: {p['next_nak']}</span></td></tr>
    <tr><td>тЩИ <b>ропрпЛроХроорпН / роХро░рогроорпН</b></td><td>ропрпЛроХроорпН: {p['yog']} | роХро░рогроорпН: {p['kar']}</td></tr>
    <tr><td>тЬи <b>роЪрпБрок роирпЗро░роЩрпНроХро│рпН</b></td><td>роиро▓рпНро▓ роирпЗро░роорпН: 10:45 AM - 11:45 AM<br>роХрпМро░ро┐ роиро▓рпНро▓ роирпЗро░роорпН: {p['gowri']}</td></tr>
    <tr style="background-color: #FFF0F0;"><td>ЁЯЪл <b>роЕроЪрпБрок роирпЗро░роЩрпНроХро│рпН</b></td><td>ро░ро╛роХрпБ: {p['rahu']} | роОроо: {p['yema']} | роХрпБро│ро┐роХрпИ: {p['kuli']}</td></tr>
    <tr><td>ЁЯУН <b>роЪрпВро▓роорпН</b></td><td>{p['shoolam']} (рокро░ро┐роХро╛ро░роорпН: родропро┐ро░рпН/рокро╛ро▓рпН)</td></tr>
    <tr><td>ЁЯУК <b>роиро┐ро▓ро╡ро┐ройрпН рокро╛роХрпИ</b></td><td>{p['m_deg']}┬░ (родро┐ро░рпБроХрпНроХрогро┐род роиро┐ро▓рпИ)</td></tr>
 </td>
</tr>

</table>
""", unsafe_allow_html=True)
