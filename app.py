import streamlit as st
import swisseph as swe
from datetime import datetime, timedelta
from geopy.geocoders import Nominatim

st.set_page_config(page_title="Astro Guide Pro", layout="wide")

def get_corrected_panchang(city_name, date_obj):
    try:
        geolocator = Nominatim(user_agent="astro_pro_final")
        loc = geolocator.geocode(city_name)
        lat, lon = (loc.latitude, loc.longitude) if loc else (13.0827, 80.2707)
    except:
        lat, lon = 13.0827, 80.2707

    jd = swe.julday(date_obj.year, date_obj.month, date_obj.day, 5.5)
    swe.set_sid_mode(swe.SIDM_LAHIRI)

    # роиро┐ро▓ро╡ро┐ройрпН рокро╛роХрпИ (Moon Degree)
    moon_pos = swe.calc_ut(jd, swe.MOON, swe.FLG_SIDEREAL)[0][0]
    
    raasis = ["роорпЗро╖роорпН", "ро░ро┐ро╖рокроорпН", "рооро┐родрпБройроорпН", "роХроЯроХроорпН", "роЪро┐роорпНроороорпН", "роХройрпНройро┐", "родрпБро▓ро╛роорпН", "ро╡ро┐ро░рпБроЪрпНроЪро┐роХроорпН", "родройрпБроЪрпБ", "роороХро░роорпН", "роХрпБроорпНрокроорпН", "роорпАройроорпН"]
    naks = ["роЕро╕рпНро╡ро┐ройро┐", "рокро░рогро┐", "роХро╛ро░рпНродрпНродро┐роХрпИ", "ро░рпЛроХро┐рогро┐", "рооро┐ро░рпБроХроЪрпАро░ро┐роЯроорпН", "родро┐ро░рпБро╡ро╛родро┐ро░рпИ", "рокрпБройро░рпНрокрпВроЪроорпН", "рокрпВроЪроорпН", "роЖропро┐ро▓рпНропроорпН", "роороХроорпН", "рокрпВро░роорпН", "роЙродрпНродро┐ро░роорпН", "роЕро╕рпНродроорпН", "роЪро┐родрпНродро┐ро░рпИ", "роЪрпБро╡ро╛родро┐", "ро╡ро┐роЪро╛роХроорпН", "роЕройрпБро╖роорпН", "роХрпЗроЯрпНроЯрпИ", "роорпВро▓роорпН", "рокрпВро░ро╛роЯроорпН", "роЙродрпНродро┐ро░ро╛роЯроорпН", "родро┐ро░рпБро╡рпЛрогроорпН", "роЕро╡ро┐роЯрпНроЯроорпН", "роЪродропроорпН", "рокрпВро░роЯрпНроЯро╛родро┐", "роЙродрпНродро┐ро░роЯрпНроЯро╛родро┐", "ро░рпЗро╡родро┐"]
    
    # родро▒рпНрокрпЛродрпИроп ро░ро╛роЪро┐ рооро▒рпНро▒рпБроорпН роироЯрпНроЪродрпНродро┐ро░роорпН
    curr_raasi_idx = int(moon_pos / 30)
    curr_raasi = raasis[curr_raasi_idx]
    curr_nak_idx = int(moon_pos / (360/27))
    curr_nak = naks[curr_nak_idx]

    # --- роЪроирпНродро┐ро░ро╛ро╖рпНроЯроо роХрогроХрпНроХрпАроЯрпБ (роЪро░ро┐ роЪрпЖропрпНропрокрпНрокроЯрпНроЯродрпБ) ---
    # ро╡ро┐родро┐: роЪроирпНродро┐ро░ройрпН роЗро░рпБроХрпНроХрпБроорпН ро░ро╛роЪро┐роХрпНроХрпБ 8-ро╡родрпБ ро░ро╛роЪро┐роХрпНроХрпБ роЪроирпНродро┐ро░ро╛ро╖рпНроЯроороорпН.
    # роОройро╡рпЗ, рокро╛родро┐роХрпНроХрокрпНрокроЯрпНроЯ ро░ро╛роЪро┐ = (роЪроирпНродро┐ро░ ро░ро╛роЪро┐ - 7) 
    # роЙродро╛ро░рогроорпН: ро╡ро┐ро░рпБроЪрпНроЪро┐роХроорпН (7) - 7 = роорпЗро╖роорпН (0). роЗродрпБ родро╡ро▒рпБ. 
    # роЪро░ро┐ропро╛рой роорпБро▒рпИ: рокро╛родро┐роХрпНроХрокрпНрокроЯрпНроЯ ро░ро╛роЪро┐ + 7 = роЪроирпНродро┐ро░ ро░ро╛роЪро┐.
    # рокро╛родро┐роХрпНроХрокрпНрокроЯрпНроЯ ро░ро╛роЪро┐ = (роЪроирпНродро┐ро░ ро░ро╛роЪро┐ - 7) % 12
    # ро╡ро┐ро░рпБроЪрпНроЪро┐роХроорпН (роЗрогрпНроЯрпЖроХрпНро╕рпН 7) роОройрпНро▒ро╛ро▓рпН: (7 - 7) = 0 (роорпЗро╖роорпН) - роЗродрпБ 8th house logic.
    # роирпАроЩрпНроХро│рпН роЪрпКройрпНройрокроЯро┐: роЪроирпНродро┐ро░ройрпН ро╡ро┐ро░рпБроЪрпНроЪро┐роХроорпН (7) роОройрпНро▒ро╛ро▓рпН, рооро┐родрпБройродрпНродро┐ро▒рпНроХрпБ (2) роЕродрпБ 8-рооро┐роЯроорпН.
    # 2 (рооро┐родрпБройроорпН) + 7 = 9 (родройрпБроЪрпБ). роЗро▓рпНро▓рпИ.
    
    # роОро│ро┐роп ро╡ро┐родро┐: роЪроирпНродро┐ро░ройрпН роЗро░рпБроХрпНроХрпБроорпН ро░ро╛роЪро┐ропро┐ро▓рпН роЗро░рпБроирпНродрпБ рокро┐ройрпНройрпЛроХрпНроХро┐ 6 ро░ро╛роЪро┐роХро│рпИ роОрогрпНрогро┐ройро╛ро▓рпН ро╡ро░рпБро╡родрпБ роЪроирпНродро┐ро░ро╛ро╖рпНроЯроо ро░ро╛роЪро┐.
    affected_raasi_idx = (curr_raasi_idx - 5) % 12 # ро╡ро┐ро░рпБроЪрпНроЪро┐роХроорпН(7) - 5 = рооро┐родрпБройроорпН(2)
    affected_raasi = raasis[affected_raasi_idx]

    # роироЯрпНроЪродрпНродро┐ро░роорпН роорпБроЯро┐ропрпБроорпН роирпЗро░роорпН (роиро┐рооро┐роЯроЩрпНроХро│рпБроЯройрпН)
    deg_left = ((curr_nak_idx + 1) * (360/27)) - moon_pos
    hours_left = deg_left / 0.55 
    end_dt = datetime.combine(date_obj, datetime.min.time()) + timedelta(hours=5.5 + hours_left)
    end_time_str = end_dt.strftime("%I:%M %p")

    return curr_raasi, curr_nak, affected_raasi, end_time_str

# --- UI ---
st.title("ЁЯМЯ роЕро╕рпНроЯрпНро░рпЛ роХрпИроЯрпБ - родрпБро▓рпНро▓ро┐ропрооро╛рой роЪроирпНродро┐ро░ро╛ро╖рпНроЯроороорпН")
city = st.sidebar.text_input("роКро░рпН:", "Chennai")
today = st.sidebar.date_input("родрпЗродро┐:", datetime.now())

c_raasi, c_nak, aff_raasi, end_t = get_corrected_panchang(city, today)

st.info(f"роЗройрпНро▒рпБ роЪроирпНродро┐ро░ройрпН роЗро░рпБроХрпНроХрпБроорпН ро░ро╛роЪро┐: **{c_raasi}** | роироЯрпНроЪродрпНродро┐ро░роорпН: **{c_nak}**")

col1, col2 = st.columns(2)

with col1:
    st.success(f"### тЬи роироЯрпНроЪродрпНродро┐ро░ ро╡ро┐рокро░роорпН\n**{c_nak}** роироЯрпНроЪродрпНродро┐ро░роорпН роЗройрпНро▒рпБ **{end_t}** ро╡ро░рпИ роЙро│рпНро│родрпБ.")

with col2:
    st.error(f"### тЪая╕П роЪроирпНродро┐ро░ро╛ро╖рпНроЯроо роОроЪрпНроЪро░ро┐роХрпНроХрпИ\nроЗройрпНро▒рпБ **{aff_raasi}** ро░ро╛роЪро┐ропро┐ройро░рпБроХрпНроХрпБ роЪроирпНродро┐ро░ро╛ро╖рпНроЯроороорпН!")
    st.write(f"({c_raasi}-ро▓рпН роЪроирпНродро┐ро░ройрпН роЗро░рпБрокрпНрокродро╛ро▓рпН, {aff_raasi}-роХрпНроХрпБ роЗродрпБ 8-роорпН роЗроЯроорпН)")
