import streamlit as st
import swisseph as swe
from datetime import datetime, timedelta
import pytz
from astral import LocationInfo
from astral.sun import sun
from timezonefinder import TimezoneFinder

# ---------- роЖрокрпН роЕроорпИрокрпНрокрпБроХро│рпН ----------
st.set_page_config(page_title="AstroGuide Tamil", layout="wide")
IST = pytz.timezone('Asia/Kolkata')

# ---------- CSS ро╡роЯро┐ро╡роорпИрокрпНрокрпБ (роЪро┐ро▒ро┐роп роОро┤рпБродрпНродрпБроХрпНроХро│рпН & роорпКрокрпИро▓рпН ро╡ро┐ропрпВ) ----------
st.markdown("""
    <style>
    .stApp { background-color: #FFFFFF; }
    h1, h2, h3, p, span, div, label, td, th { color: #1a1a1a !important; font-family: 'Arial', sans-serif; }
    .header-style { color: #8B0000 !important; text-align: center; font-weight: bold; margin-top: -30px; margin-bottom: 5px; font-size: 1.1em; }
    .main-box { max-width: 450px; margin: auto; padding: 10px; background: #fdfdfd; border-radius: 8px; border: 1px solid #8B0000; box-shadow: 0 2px 5px rgba(0,0,0,0.05); margin-bottom: 10px; }
    .panchang-table { width: 100%; border-collapse: collapse; background: white; border-radius: 5px; border: 1px solid #8B0000; font-size: 0.78em; }
    .panchang-table th { background-color: #8B0000; color: white !important; padding: 6px; text-align: center; }
    .panchang-table td { padding: 5px 8px; border: 1px solid #eee; color: #000 !important; font-weight: 500; }
    .next-info { color: #8B0000 !important; font-size: 0.7em; font-style: italic; display: block; margin-top: 1px; }
    .muhurtham-box { color: #2E7D32 !important; font-weight: bold; }
    .asubha-row { background-color: #FFF5F5; }
    </style>
    """, unsafe_allow_html=True)

# ---------------- ро▓ро╛роХро┐ройрпН ----------------
if "logged_in" not in st.session_state: st.session_state.logged_in = False
if not st.session_state.logged_in:
    st.markdown("<h1 class='header-style'>ЁЯФ▒ AstroGuide роЙро│рпНроирпБро┤рпИро╡рпБ</h1>", unsafe_allow_html=True)
    if st.button("роЙро│рпНро│рпЗ роЪрпЖро▓рпНроХ"): st.session_state.logged_in = True; st.rerun()
    st.stop()

# ---------------- рооро╛ро╡роЯрпНроЯроЩрпНроХро│рпН ----------------
districts = {"роЪрпЖройрпНройрпИ": [13.08, 80.27], "роородрпБро░рпИ": [9.93, 78.12], "родро┐ро░рпБроЪрпНроЪро┐": [10.79, 78.70], "роХрпЛро╡рпИ": [11.02, 76.96], "роирпЖро▓рпНро▓рпИ": [8.71, 77.76], "роЪрпЗро▓роорпН": [11.66, 78.15]}

st.markdown("<h1 class='header-style'>ЁЯФ▒ AstroGuide родро┐ро░рпБроХрпНроХрогро┐родрокрпН рокроЮрпНроЪро╛роЩрпНроХроорпН</h1>", unsafe_allow_html=True)
st.markdown('<div class="main-box">', unsafe_allow_html=True)
c1, c2 = st.columns(2)
with c1: s_dist = st.selectbox("роКро░рпН:", list(districts.keys()))
with c2: s_date = st.date_input("родрпЗродро┐:", datetime.now(IST))
st.markdown('</div>', unsafe_allow_html=True)

lat, lon = districts[s_dist]

def get_full_panchang_tamil(date_obj, lat, lon):
    tf = TimezoneFinder(); tz_name = tf.timezone_at(lat=lat, lng=lon) or "Asia/Kolkata"
    city = LocationInfo(latitude=lat, longitude=lon, timezone=tz_name)
    s = sun(observer=city.observer, date=date_obj, tzinfo=pytz.timezone(tz_name))
    mid = s["sunrise"] + (s["sunset"] - s["sunrise"]) / 2
    
    swe.set_sid_mode(swe.SIDM_LAHIRI)
    jd_ut = swe.julday(date_obj.year, date_obj.month, date_obj.day, 0.0)

    def get_raw(jd):
        m, _ = swe.calc_ut(jd, 1, swe.FLG_SIDEREAL); s_p, _ = swe.calc_ut(jd, 0, swe.FLG_SIDEREAL)
        t = ((m[0]-s_p[0])%360)/12
        n = m[0]/(360/27)
        y = (m[0]+s_p[0])/(360/27)
        k = ((m[0]-s_p[0])%360)/6
        return m[0], s_p[0], int(t), int(n), int(y % 27), int(k)

    def find_end_time(jd_base, cur_idx, p_type):
        low, high = 0.0, 1.3
        for _ in range(35):
            mid_v = (low + high) / 2
            res = get_raw(jd_base + mid_v)
            lookup = {"t":2, "n":3, "y":4, "k":5}[p_type]
            if res[lookup] == cur_idx: low = mid_v
            else: high = mid_v
        dt = datetime.combine(date_obj, datetime.min.time()) + timedelta(hours=5.5) + timedelta(days=low)
        day_str = "роЗройрпНро▒рпБ" if dt.date() == date_obj else "роиро╛ро│рпИ"
        return f"{day_str} {dt.strftime('%I:%M %p')}"

    m_deg, s_deg, t_n, n_n, y_n, k_n = get_raw(jd_ut)
    
    tithis = ["рокро┐ро░родроорпИ", "родрпБро╡ро┐родро┐ропрпИ", "родро┐ро░рпБродро┐ропрпИ", "роЪродрпБро░рпНродрпНродро┐", "рокроЮрпНроЪрооро┐", "роЪро╖рпНроЯро┐", "роЪрокрпНродрооро┐", "роЕро╖рпНроЯрооро┐", "роиро╡рооро┐", "родроЪрооро┐", "роПроХро╛родроЪро┐", "родрпБро╡ро╛родроЪро┐", "родро┐ро░ропрпЛродроЪро┐", "роЪродрпБро░рпНродрпНродроЪро┐", "рокрпМро░рпНрогрооро┐", "рокро┐ро░родроорпИ", "родрпБро╡ро┐родро┐ропрпИ", "родро┐ро░рпБродро┐ропрпИ", "роЪродрпБро░рпНродрпНродро┐", "рокроЮрпНроЪрооро┐", "роЪро╖рпНроЯро┐", "роЪрокрпНродрооро┐", "роЕро╖рпНроЯрооро┐", "роиро╡рооро┐", "родроЪрооро┐", "роПроХро╛родроЪро┐", "родрпБро╡ро╛родроЪро┐", "родро┐ро░ропрпЛродроЪро┐", "роЪродрпБро░рпНродрпНродроЪро┐", "роЕрооро╛ро╡ро╛роЪрпИ"]
    naks = ["роЕро╕рпНро╡ро┐ройро┐", "рокро░рогро┐", "роХро╛ро░рпНродрпНродро┐роХрпИ", "ро░рпЛроХро┐рогро┐", "рооро┐ро░рпБроХроЪрпАро░ро┐роЯроорпН", "родро┐ро░рпБро╡ро╛родро┐ро░рпИ", "рокрпБройро░рпНрокрпВроЪроорпН", "рокрпВроЪроорпН", "роЖропро┐ро▓рпНропроорпН", "роороХро░роорпН", "рокрпВро░роорпН", "роЙродрпНродро┐ро░роорпН", "роЕро╕рпНродроорпН", "роЪро┐родрпНродро┐ро░рпИ", "роЪрпБро╡ро╛родро┐", "ро╡ро┐роЪро╛роХроорпН", "роЕройрпБро╖роорпН", "роХрпЗроЯрпНроЯрпИ", "роорпВро▓роорпН", "рокрпВро░ро╛роЯроорпН", "роЙродрпНродро┐ро░ро╛роЯроорпН", "родро┐ро░рпБро╡рпЛрогроорпН", "роЕро╡ро┐роЯрпНроЯроорпН", "роЪродропроорпН", "рокрпВро░роЯрпНроЯро╛родро┐", "роЙродрпНродро┐ро░роЯрпНроЯро╛родро┐", "ро░рпЗро╡родро┐"]
    yogas = ["ро╡ро┐ро╖рпНроХроорпНрокроорпН", "рокрпНро░рпАродро┐", "роЖропрпБро╖рпНрооро╛ройрпН", "роЪрпМрокро╛роХрпНроХро┐ропроорпН", "роЪрпЛрокройроорпН", "роЕродро┐роХрогрпНроЯроорпН", "роЪрпБроХро░рпНроороорпН", "родро┐ро░рпБродро┐", "роЪрпВро▓роорпН", "роХрогрпНроЯроорпН", "ро╡ро┐ро░рпБродрпНродро┐", "родрпБро░рпБро╡роорпН", "ро╡ро┐ропро╛роХро╛родроорпН", "ро╣ро░рпНро╖рогроорпН", "ро╡роЬрпНро░роорпН", "роЪро┐родрпНродро┐", "ро╡ро┐ропродрпАрокро╛родроорпН", "ро╡ро░ро┐ропро╛ройрпН", "рокро░ро┐роХроорпН", "роЪро┐ро╡роорпН", "роЪро┐родрпНродроорпН", "роЪро╛родрпНродро┐ропроорпН", "роЪрпБрокроорпН", "роЪрпБрокрпНрокро┐ро░роорпН", "рокро┐ро░ро╛рооро┐ропроорпН", "роРроирпНродро┐ро░роорпН", "ро╡рпИродро┐ро░рпБродро┐"]
    karans = ["рокро╡роорпН", "рокро╛ро▓ро╡роорпН", "роХрпМро▓ро╡роорпН", "роЪрпИродрпБро▓рпИ", "роХро░роЪрпИ", "ро╡рогро┐роЪрпИ", "рокродрпНродро┐ро░рпИ", "роЪроХрпБройро┐", "роЪродрпБро╖рпНрокро╛родроорпН", "роиро╛роХро╡роорпН", "роХро┐роорпНро╕рпНродрпБроХрпНроХро┐ройроорпН"]
    
    d_idx = date_obj.weekday()
    wara = ["родро┐роЩрпНроХро│рпН", "роЪрпЖро╡рпНро╡ро╛ропрпН", "рокрпБродройрпН", "ро╡ро┐ропро╛ро┤ройрпН", "ро╡рпЖро│рпНро│ро┐", "роЪройро┐", "роЮро╛ропро┐ро▒рпБ"][d_idx]

    return {
        "tamil_date": f"{['роЪро┐родрпНродро┐ро░рпИ', 'ро╡рпИроХро╛роЪро┐', 'роЖройро┐', 'роЖроЯро┐', 'роЖро╡рогро┐', 'рокрпБро░роЯрпНроЯро╛роЪро┐', 'роРрокрпНрокроЪро┐', 'роХро╛ро░рпНродрпНродро┐роХрпИ', 'рооро╛ро░рпНроХро┤ро┐', 'родрпИ', 'рооро╛роЪро┐', 'рокроЩрпНроХрпБройро┐'][int(s_deg/30)%12]} {int(s_deg%30)+1}",
        "wara": wara, "rise": s["sunrise"].strftime("%I:%M %p"), "set": s["sunset"].strftime("%I:%M %p"),
        "abhijit": f"{(mid - timedelta(minutes=24)).strftime('%I:%M %p')} - {(mid + timedelta(minutes=24)).strftime('%I:%M %p')}",
        "tithi": tithis[t_n % 30], "t_e": find_end_time(jd_ut, t_n, "t"), "t_nx": tithis[(t_n+1)%30],
        "nak": naks[n_n % 27], "n_e": find_end_time(jd_ut, n_n, "n"), "n_nx": naks[(n_n+1)%27],
        "yoga": yogas[y_n % 27], "y_e": find_end_time(jd_ut, y_n, "y"),
        "karan": karans[k_n % 11], "k_e": find_end_time(jd_ut, k_n, "k"),
        "rahu": ["07:30-09:00", "15:00-16:30", "12:00-13:30", "13:30-15:00", "10:30-12:00", "09:00-10:30", "16:30-18:00"][d_idx],
        "yema": ["10:30-12:00", "09:00-10:30", "07:30-09:00", "06:00-07:30", "15:00-16:30", "13:30-15:00", "12:00-13:30"][d_idx],
        "kuli": ["13:30-15:00", "12:00-13:30", "10:30-12:00", "09:00-10:30", "07:30-09:00", "06:00-07:30", "15:00-16:30"][d_idx],
        "gowri": ["01:30-02:30 PM", "10:30-11:30 AM", "09:30-10:30 AM", "01:30-02:30 PM", "12:30-01:30 PM", "09:30-10:30 AM", "10:30-11:30 AM"][d_idx],
        "shoolam": ["роХро┐ро┤роХрпНроХрпБ", "ро╡роЯроХрпНроХрпБ", "ро╡роЯроХрпНроХрпБ", "родрпЖро▒рпНроХрпБ", "роорпЗро▒рпНроХрпБ", "роХро┐ро┤роХрпНроХрпБ", "роорпЗро▒рпНроХрпБ"][d_idx],
        "moon_deg": round(m_deg, 2)
    }

res = get_full_panchang_tamil(s_date, lat, lon)

st.markdown(f"""
<table class="panchang-table">
    <tr><th colspan="2">AstroGuide - {s_dist} ({res['wara']})</th></tr>
    <tr><td>ЁЯУЕ <b>родрооро┐ро┤рпН родрпЗродро┐</b></td><td>{res['tamil_date']}</td></tr>
    <tr><td>ЁЯМЕ <b>роЙродропроорпН / роЕро╕рпНродрооройроорпН</b></td><td>{res['rise']} / {res['set']}</td></tr>
    <tr><td>тЬи <b>роЕрокро┐роЬро┐родрпН роорпБроХрпВро░рпНродрпНродроорпН</b></td><td><span class='muhurtham-box'>{res['abhijit']}</span></td></tr>
    <tr><td>ЁЯМЩ <b>родро┐родро┐</b></td><td><b>{res['tithi']}</b> ро╡ро░рпИ ({res['t_e']})<br><span class='next-info'>роЕроЯрпБродрпНродрпБ: {res['t_nx']}</span></td></tr>
    <tr><td>тнР <b>роироЯрпНроЪродрпНродро┐ро░роорпН</b></td><td><b>{res['nak']}</b> ро╡ро░рпИ ({res['n_e']})<br><span class='next-info'>роЕроЯрпБродрпНродрпБ: {res['n_nx']}</span></td></tr>
    <tr><td>ЁЯМА <b>ропрпЛроХроорпН</b></td><td><b>{res['yoga']}</b> ро╡ро░рпИ ({res['y_e']})</td></tr>
    <tr><td>тЪЩя╕П <b>роХро░рогроорпН</b></td><td><b>{res['karan']}</b> ро╡ро░рпИ ({res['k_e']})</td></tr>
    <tr><td>ЁЯМЯ <b>роХрпМро░ро┐ роиро▓рпНро▓ роирпЗро░роорпН</b></td><td>{res['gowri']}</td></tr>
    <tr class="asubha-row"><td>ЁЯЪл <b>ро░ро╛роХрпБ роХро╛ро▓роорпН</b></td><td>{res['rahu']}</td></tr>
    <tr class="asubha-row"><td>ЁЯЪл <b>роОроороХрогрпНроЯроорпН</b></td><td>{res['yema']}</td></tr>
    <tr class="asubha-row"><td>ЁЯЪл <b>роХрпБро│ро┐роХрпИ</b></td><td>{res['kuli']}</td></tr>
    <tr><td>ЁЯУН <b>роЪрпВро▓роорпН</b></td><td>{res['shoolam']}</td></tr>
    <tr><td>ЁЯУК <b>роЪроирпНродро┐ро░ рокро╛роХрпИ</b></td><td>{res['moon_deg']}┬░ (родро┐ро░рпБроХрпНроХрогро┐родроорпН)</td></tr>
</table>
""", unsafe_allow_html=True)
# ---------- роЪроирпНродро┐ро░ро╛ро╖рпНроЯроороорпН родрпБро▓рпНро▓ро┐ропроХрпН роХрогроХрпНроХрпАроЯрпБ ----------
st.markdown("---")
st.markdown("<h3 style='text-align: center; color: #8B0000;'>ЁЯМЩ роЗройрпНро▒рпИроп роЪроирпНродро┐ро░ро╛ро╖рпНроЯроо ро╡ро┐ро╡ро░роЩрпНроХро│рпН</h3>", unsafe_allow_html=True)

# роироЯрпНроЪродрпНродро┐ро░роЩрпНроХро│ро┐ройрпН рокроЯрпНроЯро┐ропро▓рпН
naks_list = ["роЕро╕рпНро╡ро┐ройро┐", "рокро░рогро┐", "роХро╛ро░рпНродрпНродро┐роХрпИ", "ро░рпЛроХро┐рогро┐", "рооро┐ро░рпБроХроЪрпАро░ро┐роЯроорпН", "родро┐ро░рпБро╡ро╛родро┐ро░рпИ", "рокрпБройро░рпНрокрпВроЪроорпН", "рокрпВроЪроорпН", "роЖропро┐ро▓рпНропроорпН", "роороХроорпН", "рокрпВро░роорпН", "роЙродрпНродро┐ро░роорпН", "роЕро╕рпНродроорпН", "роЪро┐родрпНродро┐ро░рпИ", "роЪрпБро╡ро╛родро┐", "ро╡ро┐роЪро╛роХроорпН", "роЕройрпБро╖роорпН", "роХрпЗроЯрпНроЯрпИ", "роорпВро▓роорпН", "рокрпВро░ро╛роЯроорпН", "роЙродрпНродро┐ро░ро╛роЯроорпН", "родро┐ро░рпБро╡рпЛрогроорпН", "роЕро╡ро┐роЯрпНроЯроорпН", "роЪродропроорпН", "рокрпВро░роЯрпНроЯро╛родро┐", "роЙродрпНродро┐ро░роЯрпНроЯро╛родро┐", "ро░рпЗро╡родро┐"]

# роЗройрпНро▒рпИроп роироЯрпНроЪродрпНродро┐ро░роорпН рооро▒рпНро▒рпБроорпН роЕроЯрпБродрпНрод роироЯрпНроЪродрпНродро┐ро░родрпНродро┐ройрпН роОрогрпНроХро│рпН
current_nak_idx = n_n % 27
next_nak_idx = (current_nak_idx + 1) % 27

# роЪроирпНродро┐ро░ро╛ро╖рпНроЯроороорпН роХро╛рогрпБроорпН роироЯрпНроЪродрпНродро┐ро░роЩрпНроХро│рпИроХрпН роХрогрпНроЯро▒ро┐родро▓рпН (17-ро╡родрпБ роироЯрпНроЪродрпНродро┐ро░роорпН)
# роЗройрпНро▒рпБ роТро░рпБ роироЯрпНроЪродрпНродро┐ро░роорпН роироЯроХрпНроХрпБроорпНрокрпЛродрпБ, роЕродро┐ро▓ро┐ро░рпБроирпНродрпБ 17 роироЯрпНроЪродрпНродро┐ро░роЩрпНроХро│рпБроХрпНроХрпБ роорпБройрпНройро╛ро▓рпН роЙро│рпНро│ро╡ро░рпНроХро│рпБроХрпНроХрпБ роЪроирпНродро┐ро░ро╛ро╖рпНроЯроороорпН.
current_affected_idx = (current_nak_idx - 16) % 27
next_affected_idx = (next_nak_idx - 16) % 27

st.markdown('<div class="main-box">', unsafe_allow_html=True)

# 1. родро▒рпНрокрпЛродрпБ роироЯроХрпНроХрпБроорпН роЪроирпНродро┐ро░ро╛ро╖рпНроЯроороорпН
st.error(f"тЪая╕П **родро▒рпНрокрпЛродрпИроп роЪроирпНродро┐ро░ро╛ро╖рпНроЯроороорпН:**")
st.write(f"роироЯрпНроЪродрпНродро┐ро░роорпН: **{naks_list[current_affected_idx]}**")
st.write(f"роирпЗро░роорпН: **{res['n_e']} ро╡ро░рпИ**")

st.markdown("---")

# 2. роЕроЯрпБродрпНродрпБ родрпКроЯроЩрпНроХро╡ро┐ро░рпБроХрпНроХрпБроорпН роЪроирпНродро┐ро░ро╛ро╖рпНроЯроороорпН
st.warning(f"ЁЯХТ **роЕроЯрпБродрпНродрпБ родрпКроЯроЩрпНроХрпБроорпН роЪроирпНродро┐ро░ро╛ро╖рпНроЯроороорпН:**")
st.write(f"роироЯрпНроЪродрпНродро┐ро░роорпН: **{naks_list[next_affected_idx]}**")
st.write(f"роирпЗро░роорпН: **{res['n_e']} роорпБродро▓рпН родрпКроЯроЩрпНроХрпБроХро┐ро▒родрпБ**")

st.info("ЁЯТб **роХрпБро▒ро┐рокрпНрокрпБ:** роЪроирпНродро┐ро░ро╛ро╖рпНроЯроо роиро╛роЯрпНроХро│ро┐ро▓рпН рокрпБродро┐роп роорпБропро▒рпНроЪро┐роХро│рпН рооро▒рпНро▒рпБроорпН ро╡ро╛роХрпНроХрпБро╡ро╛родроЩрпНроХро│рпИродрпН родро╡ро┐ро░рпНрокрпНрокродрпБ роиро▓роорпН.")
st.markdown('</div>', unsafe_allow_html=True)
