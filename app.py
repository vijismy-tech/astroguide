import streamlit as st
import swisseph as swe
from datetime import datetime, timedelta
import pytz

# роЖрокрпН роЕроорпИрокрпНрокрпБроХро│рпН
st.set_page_config(page_title="TN 38 Districts Precise Panchangam", layout="wide")
IST = pytz.timezone('Asia/Kolkata')

# --- CSS ро╡роЯро┐ро╡роорпИрокрпНрокрпБ (Design рооро╛ро▒ро╡ро┐ро▓рпНро▓рпИ) ---
st.markdown("""
    <style>
    .stApp { background-color: #FDFCF0; }
    .header-style { color: #8B0000; text-align: center; font-family: 'Tamil'; font-weight: bold; margin-bottom: 20px; }
    .panchang-table {
        width: 100%; border-collapse: collapse; background: white;
        border-radius: 15px; overflow: hidden; box-shadow: 0 4px 15px rgba(0,0,0,0.1);
    }
    .panchang-table th { background-color: #8B0000; color: white; padding: 15px; text-align: left; }
    .panchang-table td { padding: 12px 15px; border: 1px solid #eee; color: #333; font-weight: 600; }
    .sub-text { color: #666; font-size: 0.85em; font-weight: normal; }
    .special-note { background-color: #FFF9C4; padding: 15px; border-radius: 10px; border-left: 5px solid #FBC02D; margin-bottom: 20px; color: #5D4037; font-weight: bold; }
    </style>
    """, unsafe_allow_html=True)

# родрооро┐ро┤рпНроиро╛роЯрпНроЯро┐ройрпН 38 рооро╛ро╡роЯрпНроЯроЩрпНроХро│рпН рооро▒рпНро▒рпБроорпН рокрпБродрпБроЪрпНроЪрпЗро░ро┐ (Coordinates)
locations = {
    "роЕро░ро┐ропро▓рпВро░рпН": [11.14, 79.08], "роЪрпЖроЩрпНроХро▓рпНрокроЯрпНроЯрпБ": [12.68, 79.98], "роЪрпЖройрпНройрпИ": [13.08, 80.27],
    "роХрпЛропроорпНрокрпБродрпНродрпВро░рпН": [11.02, 76.96], "роХроЯро▓рпВро░рпН": [11.75, 79.77], "родро░рпНроорокрпБро░ро┐": [12.13, 78.16],
    "родро┐рогрпНроЯрпБроХрпНроХро▓рпН": [10.37, 77.98], "роИро░рпЛроЯрпБ": [11.34, 77.72], "роХро│рпНро│роХрпНроХрпБро▒ро┐роЪрпНроЪро┐": [11.74, 78.96],
    "роХро╛роЮрпНроЪро┐рокрпБро░роорпН": [12.83, 79.70], "роХройрпНройро┐ропро╛роХрпБрооро░ро┐": [8.09, 77.54], "роХро░рпВро░рпН": [10.96, 78.08],
    "роХро┐ро░рпБро╖рпНрогроХро┐ро░ро┐": [12.53, 78.21], "роородрпБро░рпИ": [9.93, 78.12], "рооропро┐ро▓ро╛роЯрпБродрпБро▒рпИ": [11.10, 79.65],
    "роиро╛роХрокрпНрокроЯрпНроЯро┐ройроорпН": [10.77, 79.84], "роиро╛роороХрпНроХро▓рпН": [11.22, 78.17], "рокрпЖро░роорпНрокро▓рпВро░рпН": [11.23, 78.88],
    "рокрпБродрпБроХрпНроХрпЛроЯрпНроЯрпИ": [10.38, 78.82], "роЗро░ро╛роороиро╛родрокрпБро░роорпН": [9.36, 78.84], "роЗро░ро╛рогро┐рокрпНрокрпЗроЯрпНроЯрпИ": [12.93, 79.33],
    "роЪрпЗро▓роорпН": [11.66, 78.15], "роЪро┐ро╡роХро╛роЪро┐ (ро╡ро┐ро░рпБродрпБроироХро░рпН)": [9.45, 77.80], "роЪро┐ро╡роХроЩрпНроХрпИ": [9.84, 78.48],
    "родрпЖройрпНроХро╛роЪро┐": [8.96, 77.31], "родроЮрпНроЪро╛ро╡рпВро░рпН": [10.79, 79.14], "роирпАро▓роХро┐ро░ро┐": [11.41, 76.70],
    "родрпЗройро┐": [10.01, 77.48], "родро┐ро░рпБро╡ро│рпНро│рпВро░рпН": [13.12, 79.91], "родро┐ро░рпБро╡рогрпНрогро╛рооро▓рпИ": [12.23, 79.07],
    "родро┐ро░рпБро╡ро╛ро░рпВро░рпН": [10.77, 79.64], "родрпВродрпНродрпБроХрпНроХрпБроЯро┐": [8.81, 78.13], "родро┐ро░рпБроЪрпНроЪро┐ро░ро╛рокрпНрокро│рпНро│ро┐": [10.79, 78.70],
    "родро┐ро░рпБроирпЖро▓рпНро╡рпЗро▓ро┐": [8.71, 77.76], "родро┐ро░рпБрокрпНрокродрпНродрпВро░рпН": [12.49, 78.57], "родро┐ро░рпБрокрпНрокрпВро░рпН": [11.11, 77.34],
    "ро╡рпЗро▓рпВро░рпН": [12.92, 79.13], "ро╡ро┐ро┤рпБрокрпНрокрпБро░роорпН": [11.94, 79.49], "ро╡ро┐ро░рпБродрпБроироХро░рпН": [9.58, 77.95],
    "рокрпБродрпБроЪрпНроЪрпЗро░ро┐ (Union Territory)": [11.94, 79.81]
}

def get_complete_panchang(date_obj, lat, lon):
    # Integer conversions
    y, m, d = int(date_obj.year), int(date_obj.month), int(date_obj.day)
    jd_ut = swe.julday(y, m, d, 0.0) 
    swe.set_sid_mode(swe.SIDM_LAHIRI)
    swe.set_topo(lon, lat, 0)

    def get_raw_astro(jd):
        m, _ = swe.calc_ut(jd, 1, swe.FLG_SIDEREAL)
        s, _ = swe.calc_ut(jd, 0, swe.FLG_SIDEREAL)
        m_deg, s_deg = m[0], s[0]
        diff = (m_deg - s_deg) % 360
        return m_deg, s_deg, int(diff / 12), int(m_deg / (360/27)), int(((m_deg + s_deg) % 360) / (360/27)), int(diff / 6) % 11

    # --- роЙроЩрпНроХро│рпН 35-Iteration рокро╛роХрпИ роХрогроХрпНроХрпАроЯрпБ ---
    def find_boundary(jd_base, current_idx, c_type):
        low, high = 0.0, 1.3 
        for _ in range(35):
            mid = (low + high) / 2
            m, s, t, n, y, k = get_raw_astro(jd_base + mid)
            val = n if c_type == "nak" else t
            if val == current_idx: low = mid
            else: high = mid
        return datetime.combine(date_obj, datetime.min.time()) + timedelta(hours=5.5) + timedelta(days=low)

    m_start, s_start, t_now, n_now, y_now, k_now = get_raw_astro(jd_ut)
    t_end_dt = find_boundary(jd_ut, t_now, "tithi")
    n_end_dt = find_boundary(jd_ut, n_now, "nak")

    # родрпБро▓рпНро▓ро┐ропрооро╛рой роЪрпВро░ро┐роп роЙродропроорпН/роЕро╕рпНродрооройроорпН (Selected Location based)
    rise_res = swe.rise_trans(jd_ut, 0, lon, lat, 0, int(swe.CALC_RISE | swe.BIT_DISC_CENTER))
    set_res = swe.rise_trans(jd_ut, 0, lon, lat, 0, int(swe.CALC_SET | swe.BIT_DISC_CENTER))
    
    sunrise = (datetime.combine(date_obj, datetime.min.time()) + timedelta(days=rise_res[1]-jd_ut) + timedelta(hours=5, minutes=30)).strftime("%I:%M %p")
    sunset = (datetime.combine(date_obj, datetime.min.time()) + timedelta(days=set_res[1]-jd_ut) + timedelta(hours=5, minutes=30)).strftime("%I:%M %p")

    # родрооро┐ро┤рпН родрпЗродро┐
    t_months = ["роЪро┐родрпНродро┐ро░рпИ", "ро╡рпИроХро╛роЪро┐", "роЖройро┐", "роЖроЯро┐", "роЖро╡рогро┐", "рокрпБро░роЯрпНроЯро╛роЪро┐", "роРрокрпНрокроЪро┐", "роХро╛ро░рпНродрпНродро┐роХрпИ", "рооро╛ро░рпНроХро┤ро┐", "родрпИ", "рооро╛роЪро┐", "рокроЩрпНроХрпБройро┐"]
    tamil_full = f"{t_months[int(s_start / 30) % 12]} {int(s_start % 30) + 1}"

    wara = ["родро┐роЩрпНроХроЯрпНроХро┐ро┤роорпИ", "роЪрпЖро╡рпНро╡ро╛ропрпНроХрпНроХро┐ро┤роорпИ", "рокрпБродройрпНроХро┐ро┤роорпИ", "ро╡ро┐ропро╛ро┤роХрпНроХро┐ро┤роорпИ", "ро╡рпЖро│рпНро│ро┐роХрпНроХро┐ро┤роорпИ", "роЪройро┐роХрпНроХро┐ро┤роорпИ", "роЮро╛ропро┐ро▒рпНро▒рпБроХрпНроХро┐ро┤роорпИ"][date_obj.weekday()]

    return {
        "tamil": tamil_full, "wara": wara, "sunrise": sunrise, "sunset": sunset,
        "tithi": ["рокро┐ро░родроорпИ", "родрпБро╡ро┐родро┐ропрпИ", "родро┐ро░рпБродро┐ропрпИ", "роЪродрпБро░рпНродрпНродро┐", "рокроЮрпНроЪрооро┐", "роЪро╖рпНроЯро┐", "роЪрокрпНродрооро┐", "роЕро╖рпНроЯрооро┐", "роиро╡рооро┐", "родроЪрооро┐", "роПроХро╛родроЪро┐", "родрпБро╡ро╛родроЪро┐", "родро┐ро░ропрпЛродроЪро┐", "роЪродрпБро░рпНродрпНродроЪро┐", "рокрпМро░рпНрогрооро┐", "рокро┐ро░родроорпИ", "родрпБро╡ро┐родро┐ропрпИ", "родро┐ро░рпБродро┐ропрпИ", "роЪродрпБро░рпНродрпНродро┐", "рокроЮрпНроЪрооро┐", "роЪро╖рпНроЯро┐", "роЪрокрпНродрооро┐", "роЕро╖рпНроЯрооро┐", "роиро╡рооро┐", "родроЪрооро┐", "роПроХро╛родроЪро┐", "родрпБро╡ро╛родроЪро┐", "родро┐ро░ропрпЛродроЪро┐", "роЪродрпБро░рпНродрпНродроЪро┐", "роЕрооро╛ро╡ро╛роЪрпИ"][t_now % 30],
        "t_end": t_end_dt.strftime("%I:%M %p"),
        "nak": ["роЕро╕рпНро╡ро┐ройро┐", "рокро░рогро┐", "роХро╛ро░рпНродрпНродро┐роХрпИ", "ро░рпЛроХро┐рогро┐", "рооро┐ро░рпБроХроЪрпАро░ро┐роЯроорпН", "родро┐ро░рпБро╡ро╛родро┐ро░рпИ", "рокрпБройро░рпНрокрпВроЪроорпН", "рокрпВроЪроорпН", "роЖропро┐ро▓рпНропроорпН", "роороХроорпН", "рокрпВро░роорпН", "роЙродрпНродро┐ро░роорпН", "роЕро╕рпНродроорпН", "роЪро┐родрпНродро┐ро░рпИ", "роЪрпБро╡ро╛родро┐", "ро╡ро┐роЪро╛роХроорпН", "роЕройрпБро╖роорпН", "роХрпЗроЯрпНроЯрпИ", "роорпВро▓роорпН", "рокрпВро░ро╛роЯроорпН", "роЙродрпНродро┐ро░ро╛роЯроорпН", "родро┐ро░рпБро╡рпЛрогроорпН", "роЕро╡ро┐роЯрпНроЯроорпН", "роЪродропроорпН", "рокрпВро░роЯрпНроЯро╛родро┐", "роЙродрпНродро┐ро░роЯрпНроЯро╛родро┐", "ро░рпЗро╡родро┐"][n_now % 27],
        "n_end": n_end_dt.strftime("%I:%M %p"),
        "yog": ["ро╡ро┐ро╖рпНроХроорпНрокроорпН", "рокрпНро░рпАродро┐", "роЖропрпБро╖рпНрооро╛ройрпН", "роЪрпМрокро╛роХрпНроХро┐ропроорпН", "роЪрпЛрокройроорпН", "роЕродро┐роХрогрпНроЯроорпН", "роЪрпБроХро░рпНроороорпН", "родро┐ро░рпБродро┐", "роЪрпВро▓роорпН", "роХрогрпНроЯроорпН", "ро╡ро┐ро░рпБродрпНродро┐", "родрпБро░рпБро╡роорпН", "ро╡ро┐ропро╛роХро╛родроорпН", "ро╣ро░рпНро╖рогроорпН", "ро╡роЬрпНро░роорпН", "роЪро┐родрпНродро┐", "ро╡ро┐ропродрпАрокро╛родроорпН", "ро╡ро░ро┐ропро╛ройрпН", "рокро░ро┐роХроорпН", "роЪро┐ро╡роорпН", "роЪро┐родрпНродроорпН", "роЪро╛родрпНродро┐ропроорпН", "роЪрпБрокроорпН", "роЪрпБрокрпНрокро┐ро░роорпН", "рокро┐ро░ро╛рооро┐ропроорпН", "роРроирпНродро░роорпН", "ро╡рпИродро┐ро░рпБродро┐"][y_now % 27],
        "kar": ["рокро╡роорпН", "рокро╛ро▓ро╡роорпН", "роХрпМро▓ро╡роорпН", "роЪрпИродро┐ро▓рпИ", "роХро░роЪрпИ", "ро╡рогро┐роЪрпИ", "рокродрпНродро┐ро░рпИ", "роЪроХрпБройро┐", "роЪродрпБро╖рпНрокро╛родроорпН", "роиро╛роХро╡роорпН", "роХро┐роорпНро╕рпНродрпБроХрпНройроорпН"][k_now % 11],
        "m_deg": round(m_start, 2)
    }

# --- UI Layout ---
st.markdown("<h1 class='header-style'>ЁЯФ▒ родрооро┐ро┤рпНроиро╛роЯрпБ 38 рооро╛ро╡роЯрпНроЯ родро┐ро░рпБроХрпНроХрогро┐родрокрпН рокроЮрпНроЪро╛роЩрпНроХроорпН</h1>", unsafe_allow_html=True)



with st.sidebar:
    st.header("ЁЯУН роЗро░рпБрокрпНрокро┐роЯродрпН родрпЗро░рпНро╡рпБ")
    selected_loc = st.selectbox("рооро╛ро╡роЯрпНроЯродрпНродрпИродрпН родрпЗро░рпНроирпНродрпЖроЯрпБроХрпНроХро╡рпБроорпН:", list(locations.keys()))
    selected_date = st.date_input("родрпЗродро┐ропрпИродрпН родрпЗро░рпНроирпНродрпЖроЯрпБроХрпНроХро╡рпБроорпН:", datetime.now(IST))

lat, lon = locations[selected_loc]
p = get_complete_panchang(selected_date, lat, lon)

st.markdown(f"<div class='special-note'>ЁЯУЕ родрооро┐ро┤рпН родрпЗродро┐: {p['tamil']} | {p['wara']} | роЗроЯроорпН: {selected_loc}</div>", unsafe_allow_html=True)

st.markdown(f"""
<table class="panchang-table">
    <tr><th>роЕроЩрпНроХроорпН</th><th>ро╡ро┐ро╡ро░роорпН</th></tr>
    <tr><td>ЁЯМЕ <b>роЪрпВро░ро┐роп роЙродропроорпН / роЕро╕рпНродрооройроорпН</b></td><td>роЙродропроорпН: <b>{p['sunrise']}</b> | роЕро╕рпНродрооройроорпН: <b>{p['sunset']}</b></td></tr>
    <tr><td>ЁЯМЩ <b>родро┐родро┐ роЪроЮрпНроЪро╛ро░роорпН</b></td><td><b>{p['tithi']}</b> (роорпБроЯро┐ро╡рпБ: {p['t_end']})</td></tr>
    <tr><td>тнР <b>роироЯрпНроЪродрпНродро┐ро░роорпН</b></td><td><b>{p['nak']}</b> (роорпБроЯро┐ро╡рпБ: {p['n_end']})</td></tr>
    <tr><td>тЩИ <b>ропрпЛроХроорпН / роХро░рогроорпН</b></td><td>ропрпЛроХроорпН: {p['yog']} | роХро░рогроорпН: {p['kar']}</td></tr>
    <tr><td>ЁЯУК <b>ро╡ро╛ройро┐ропро▓рпН рокро╛роХрпИ</b></td><td>роиро┐ро▓ро╡ро┐ройрпН рокро╛роХрпИ: {p['m_deg']}┬░</td></tr>
</table>
""", unsafe_allow_html=True)
