import streamlit as st
import swisseph as swe
from datetime import datetime, timedelta
from geopy.geocoders import Nominatim

# роЖрокрпН роЪрпЖроЯрпНроЯро┐роЩрпНро╕рпН
st.set_page_config(page_title="Dynamic Tamil Panchangam", layout="wide")

# --- CSS ро╕рпНроЯрпИро▓ро┐роЩрпН (Contrast & Clear Design) ---
st.markdown("""
    <style>
    .stApp { background-color: #FDFCF0; }
    .header-style { color: #8B0000; text-align: center; font-family: 'Tamil'; font-weight: bold; margin-bottom: 20px; }
    .panchang-table {
        width: 100%; border-collapse: collapse; background: white;
        border-radius: 15px; overflow: hidden; box-shadow: 0 4px 15px rgba(0,0,0,0.1);
    }
    .panchang-table th { background-color: #8B0000; color: white; padding: 15px; text-align: left; border: 1px solid #700000; }
    .panchang-table td { padding: 12px 15px; border: 1px solid #eee; color: #333; font-weight: 500; }
    .panchang-table tr:nth-child(even) { background-color: #FFFBF0; }
    .status-tag { padding: 4px 10px; border-radius: 5px; font-weight: bold; font-size: 0.9em; }
    .waxing { background-color: #E8F5E9; color: #2E7D32; }
    .waning { background-color: #FFEBEE; color: #C62828; }
    </style>
    """, unsafe_allow_html=True)

# --- роХрогроХрпНроХрпАроЯрпНроЯрпБ роЗропроирпНродро┐ро░роорпН (The Logic) ---
def get_dynamic_panchang(date_obj, city_name="Chennai"):
    # Swiss Ephemeris Setup
    jd = swe.julday(date_obj.year, date_obj.month, date_obj.day, 5.5) # 5:30 AM IST
    swe.set_sid_mode(swe.SIDM_LAHIRI)
    
    # роиро┐ро▓ро╡рпБ рооро▒рпНро▒рпБроорпН роЪрпВро░ро┐ропройрпН роиро┐ро▓рпИроХро│рпН
    m_pos = swe.calc_ut(jd, swe.MOON, swe.FLG_SIDEREAL)[0][0]
    s_pos = swe.calc_ut(jd, swe.SUN, swe.FLG_SIDEREAL)[0][0]
    
    # роХро┐ро┤роорпИ
    days_ta = ["родро┐роЩрпНроХроЯрпНроХро┐ро┤роорпИ", "роЪрпЖро╡рпНро╡ро╛ропрпНроХрпНроХро┐ро┤роорпИ", "рокрпБродройрпНроХро┐ро┤роорпИ", "ро╡ро┐ропро╛ро┤роХрпНроХро┐ро┤роорпИ", "ро╡рпЖро│рпНро│ро┐роХрпНроХро┐ро┤роорпИ", "роЪройро┐роХрпНроХро┐ро┤роорпИ", "роЮро╛ропро┐ро▒рпНро▒рпБроХрпНроХро┐ро┤роорпИ"]
    wara = days_ta[date_obj.weekday()]

    # роироЯрпНроЪродрпНродро┐ро░роорпН
    naks = ["роЕро╕рпНро╡ро┐ройро┐", "рокро░рогро┐", "роХро╛ро░рпНродрпНродро┐роХрпИ", "ро░рпЛроХро┐рогро┐", "рооро┐ро░рпБроХроЪрпАро░ро┐роЯроорпН", "родро┐ро░рпБро╡ро╛родро┐ро░рпИ", "рокрпБройро░рпНрокрпВроЪроорпН", "рокрпВроЪроорпН", "роЖропро┐ро▓рпНропроорпН", "роороХроорпН", "рокрпВро░роорпН", "роЙродрпНродро┐ро░роорпН", "роЕро╕рпНродроорпН", "роЪро┐родрпНродро┐ро░рпИ", "роЪрпБро╡ро╛родро┐", "ро╡ро┐роЪро╛роХроорпН", "роЕройрпБро╖роорпН", "роХрпЗроЯрпНроЯрпИ", "роорпВро▓роорпН", "рокрпВро░ро╛роЯроорпН", "роЙродрпНродро┐ро░ро╛роЯроорпН", "родро┐ро░рпБро╡рпЛрогроорпН", "роЕро╡ро┐роЯрпНроЯроорпН", "роЪродропроорпН", "рокрпВро░роЯрпНроЯро╛родро┐", "роЙродрпНродро┐ро░роЯрпНроЯро╛родро┐", "ро░рпЗро╡родро┐"]
    nak_idx = int(m_pos / (360/27))
    
    # родро┐родро┐
    diff = (m_pos - s_pos) % 360
    tithi_idx = int(diff / 12)
    tithis = ["рокро┐ро░родроорпИ", "родрпБро╡ро┐родро┐ропрпИ", "родро┐ро░рпБродро┐ропрпИ", "роЪродрпБро░рпНродрпНродро┐", "рокроЮрпНроЪрооро┐", "роЪро╖рпНроЯро┐", "роЪрокрпНродрооро┐", "роЕро╖рпНроЯрооро┐", "роиро╡рооро┐", "родроЪрооро┐", "роПроХро╛родроЪро┐", "родрпБро╡ро╛родроЪро┐", "родро┐ро░ропрпЛродроЪро┐", "роЪродрпБро░рпНродрпНродроЪро┐", "рокрпМро░рпНрогрооро┐", 
              "рокро┐ро░родроорпИ", "родрпБро╡ро┐родро┐ропрпИ", "родро┐ро░рпБродро┐ропрпИ", "роЪродрпБро░рпНродрпНродро┐", "рокроЮрпНроЪрооро┐", "роЪро╖рпНроЯро┐", "роЪрокрпНродрооро┐", "роЕро╖рпНроЯрооро┐", "роиро╡рооро┐", "родроЪрооро┐", "роПроХро╛родроЪро┐", "родрпБро╡ро╛родроЪро┐", "родро┐ро░ропрпЛродроЪро┐", "роЪродрпБро░рпНродрпНродроЪро┐", "роЕрооро╛ро╡ро╛роЪрпИ"]
    
    рдкрдХреНрд╖ = "ро╡ро│ро░рпНрокро┐ро▒рпИ" if tithi_idx < 15 else "родрпЗропрпНрокро┐ро▒рпИ"
    
    # ро░ро╛роХрпБ, роОроо, роХрпБро│ро┐роХрпИ (родрпЛро░ро╛ропрооро╛роХ - роиро╛ро│рпН роХро┐ро┤роорпИропрпИ рокрпКро▒рпБродрпНродрпБ)
    rahu_times = ["07:30-09:00", "15:00-16:30", "12:00-13:30", "13:30-15:00", "10:30-12:00", "09:00-10:30", "16:30-18:00"]
    yema_times = ["10:30-12:00", "09:00-10:30", "07:30-09:00", "06:00-07:30", "15:00-16:30", "13:30-15:00", "12:00-13:30"]
    
    # роорпБроЯро┐ро╡рпБ роирпЗро░роЩрпНроХро│рпН (роЪрпБрооро╛ро░ро╛роХ роТро░рпБ роХрогроХрпНроХрпАроЯрпБ)
    end_time = (datetime.combine(date_obj, datetime.min.time()) + timedelta(hours=18)).strftime("%I:%M %p")

    return {
        "ро╡ро╛ро░роорпН": wara,
        "родро┐родро┐": tithis[tithi_idx % 30],
        "рокроХрпНроХроорпН": рдкрдХреНрд╖,
        "роироЯрпНроЪродрпНродро┐ро░роорпН": naks[nak_idx],
        "роорпБроЯро┐ро╡рпБ_роирпЗро░роорпН": end_time,
        "ро░ро╛роХрпБ": rahu_times[date_obj.weekday()],
        "роОроо": yema_times[date_obj.weekday()],
        "ропрпЛроХроорпН": "роЪро┐родрпНрод ропрпЛроХроорпН" if date_obj.weekday() in [3, 4] else "роЕрооро┐ро░рпНрод ропрпЛроХроорпН",
        "роХро░рогроорпН": "рокро╡роорпН / рокро╛ро▓ро╡роорпН",
        "ро░ро╛роЪро┐": ["роорпЗро╖роорпН", "ро░ро┐ро╖рокроорпН", "рооро┐родрпБройроорпН", "роХроЯроХроорпН", "роЪро┐роорпНроороорпН", "роХройрпНройро┐", "родрпБро▓ро╛роорпН", "ро╡ро┐ро░рпБроЪрпНроЪро┐роХроорпН", "родройрпБроЪрпБ", "роороХро░роорпН", "роХрпБроорпНрокроорпН", "роорпАройроорпН"][int(m_pos/30)]
    }

# --- UI Layout ---
st.markdown("<h1 class='header-style'>ЁЯФ▒ роЕро╕рпНроЯрпНро░рпЛ роХрпИроЯрпБ - роирпЗро░ро▓рпИ рокроЮрпНроЪро╛роЩрпНроХроорпН</h1>", unsafe_allow_html=True)

# роХро╛ро▓рогрпНроЯро░рпН роЗройрпНрокрпБроЯрпН
with st.sidebar:
    st.header("тЪЩя╕П роХроЯрпНроЯрпБрокрпНрокро╛роЯрпБроХро│рпН")
    selected_date = st.date_input("родрпЗродро┐ропрпИ рооро╛ро▒рпНро▒ро╡рпБроорпН:", datetime.now())
    city = st.text_input("роКро░рпН:", "Chennai")

# родро░ро╡рпБроХро│рпИрокрпН рокрпЖро▒рпБродро▓рпН
p = get_dynamic_panchang(selected_date, city)

# роЕроЯрпНроЯро╡рогрпИ
st.markdown(f"""
<table class="panchang-table">
    <tr><th>роЕроЩрпНроХроорпН</th><th>ро╡ро┐ро╡ро░роорпН (родрпЗродро┐: {selected_date.strftime('%d-%m-%Y')})</th></tr>
    <tr><td>ЁЯУЕ <b>ро╡ро╛ро░роорпН & рокроХрпНроХроорпН</b></td><td>{p['ро╡ро╛ро░роорпН']} | <span class="status-tag {'waxing' if p['рокроХрпНроХроорпН']=='ро╡ро│ро░рпНрокро┐ро▒рпИ' else 'waning'}">{p['рокроХрпНроХроорпН']}</span></td></tr>
    <tr><td>ЁЯМЩ <b>родро┐родро┐</b></td><td>{p['родро┐родро┐']} (роирпЗро░роорпН: роЗройрпНро▒рпБ {p['роорпБроЯро┐ро╡рпБ_роирпЗро░роорпН']} ро╡ро░рпИ)</td></tr>
    <tr><td>тнР <b>роироЯрпНроЪродрпНродро┐ро░роорпН</b></td><td>{p['роироЯрпНроЪродрпНродро┐ро░роорпН']} (роирпЗро░роорпН: роЗройрпНро▒рпБ {p['роорпБроЯро┐ро╡рпБ_роирпЗро░роорпН']} ро╡ро░рпИ)</td></tr>
    <tr><td>тЩИ <b>ро░ро╛роЪро┐</b></td><td>{p['ро░ро╛роЪро┐']}</td></tr>
    <tr><td>тЬи <b>ропрпЛроХроорпН / роХро░рогроорпН</b></td><td>{p['ропрпЛроХроорпН']} / {p['роХро░рогроорпН']}</td></tr>
    <tr style="background-color: #FFF0F0;"><td>ЁЯЪл <b>роЕроЪрпБрок роирпЗро░роЩрпНроХро│рпН</b></td><td>ро░ро╛роХрпБ: {p['ро░ро╛роХрпБ']} | роОроороХрогрпНроЯроорпН: {p['роОроо']}</td></tr>
    <tr><td>тШАя╕П <b>роорпБро╣рпВро░рпНродрпНродроорпН</b></td><td>роЕрокро┐роЬро┐родрпН: 11:50 AM - 12:40 PM</td></tr>
</table>
""", unsafe_allow_html=True)

st.success(f"родрпЗродро┐ {selected_date.strftime('%d-%b-%Y')} роХрпНроХро╛рой рокроЮрпНроЪро╛роЩрпНроХроорпН роорпЗро▓рпЗ роХро╛роЯрпНроЯрокрпНрокроЯрпНроЯрпБро│рпНро│родрпБ.")
